<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bubble Shot</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #111;
            color: white;
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            touch-action: none;
            user-select: none;
            -webkit-user-select: none;
        }
        #game-container {
            position: relative;
            width: 100vw;
            height: 100dvh;
            overflow: hidden;
            background-color: #050510;
        }
        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }
        
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* --- 上部エリア --- */
        #top-area {
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0));
            z-index: 10;
            padding-top: 10px;
            box-sizing: border-box;
            position: relative; /* ヒントボタン配置用 */
        }

        /* ヒントボタン & オーバーレイ */
        #hint-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(0, 255, 255, 0.1);
            border: 2px solid #00FFFF;
            color: #00FFFF;
            font-weight: bold;
            font-size: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            cursor: pointer;
            z-index: 20;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }
        #hint-btn:active { transform: scale(0.9); background: rgba(0, 255, 255, 0.3); }

        #hint-overlay {
            position: absolute;
            top: 65px; /* ボタンの下 */
            left: 15px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid #00FFFF;
            padding: 10px 15px;
            border-radius: 8px;
            color: #FFDC00;
            font-size: 16px;
            font-weight: bold;
            pointer-events: none;
            z-index: 20;
            white-space: nowrap;
            display: none; /* 初期非表示 */
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.8);
        }
        #hint-overlay.show { display: block; }

        /* タイムバー */
        #time-bar-wrapper {
            width: 90%;
            height: 8px;
            background: #333;
            border-radius: 4px;
            margin-bottom: 8px;
            border: 1px solid #555;
            position: relative;
            overflow: hidden;
        }
        #time-bar {
            width: 100%;
            height: 100%;
            background: #0074D9;
            transition: width 0.2s linear, background 0.5s;
        }
        
        #target-label { font-size: 12px; color: #00FFFF; letter-spacing: 3px; margin-top: 5px;}
        #target-display {
            font-size: 60px;
            font-weight: 800;
            color: #FFDC00;
            line-height: 1.0;
            margin: 0;
            text-shadow: 0 0 15px rgba(255, 220, 0, 0.6);
        }
        #status-bar {
            color: #ccc;
            font-family: monospace;
            font-size: 16px;
            display: flex;
            gap: 20px;
            font-weight: bold;
            margin-top: 5px;
        }

        /* フィーバーゲージ */
        #fever-label { font-size: 10px; color: #aaa; margin-top: 5px; letter-spacing: 1px;}
        #fever-gauge-container {
            width: 200px;
            height: 6px;
            background: #333;
            border-radius: 3px;
            overflow: hidden;
        }
        #fever-gauge {
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #FFDC00, #FF4136);
            transition: width 0.3s;
        }

        /* --- 下部エリア --- */
        #bottom-area {
            height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-end;
            padding-bottom: 30px;
            background: linear-gradient(to top, rgba(0,20,30,0.95) 60%, rgba(0,0,0,0));
            z-index: 10;
        }

        #formula-bar {
            min-height: 30px;
            margin-bottom: 15px;
            font-size: 22px; 
            color: #00FFFF;
            font-weight: bold;
            text-shadow: 0 0 8px #00FFFF;
            white-space: nowrap;
            max-width: 90%;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        #btn-group {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        #fire-btn {
            width: 140px;
            height: 60px;
            background: rgba(255, 65, 54, 0.1);
            border: 2px solid #555;
            color: #555;
            font-size: 24px;
            font-weight: 900;
            letter-spacing: 2px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 30px;
            transition: all 0.2s;
            cursor: pointer;
            pointer-events: none;
            backdrop-filter: blur(5px);
        }
        #fire-btn.ready {
            background: #FF4136;
            border-color: #FF851B;
            color: white;
            box-shadow: 0 0 25px rgba(255, 65, 54, 0.6);
            pointer-events: auto;
            transform: scale(1.05);
        }
        #fire-btn:active { transform: scale(0.95); background: #fff; color: #FF4136; }

        #reset-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #00FFFF;
            color: #00FFFF;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 11px;
            cursor: pointer;
            background: rgba(0, 255, 255, 0.1);
            pointer-events: auto;
            box-shadow: 0 0 10px rgba(0, 255, 255, 0.2);
        }

        #guide-msg {
            color: #00FFFF;
            font-size: 14px;
            margin-bottom: 5px;
            min-height: 20px;
            text-shadow: 1px 1px 0 #000;
        }

        /* フィーバー時のスタイル */
        body.fever-mode #top-area {
            background: linear-gradient(to bottom, rgba(255, 0, 0, 0.6), rgba(0,0,0,0));
        }
        body.fever-mode #target-display {
            color: #FFF;
            text-shadow: 0 0 10px #FF0000;
        }
        body.fever-mode #target-label {
            color: #FFaaaa;
        }

        /* --- 画面オーバーレイ --- */
        #menu-screen, #gameover-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(5, 10, 20, 0.95);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: auto;
            z-index: 20;
            text-align: center;
            border: 3px solid #00FFFF;
            box-sizing: border-box;
            backdrop-filter: blur(10px);
        }
        h1 { 
            color: #00FFFF; 
            font-size: 42px; 
            font-weight: 900;
            text-shadow: 0 0 20px #00FFFF; 
            margin-bottom: 10px;
            letter-spacing: 2px;
            font-style: italic;
        }
        .btn {
            padding: 15px 50px;
            font-size: 20px;
            background: rgba(255, 220, 0, 0.1);
            border: 2px solid #FFDC00;
            color: #FFDC00;
            cursor: pointer;
            font-weight: bold;
            border-radius: 30px;
            box-shadow: 0 0 15px rgba(255, 220, 0, 0.3);
            transition: all 0.2s;
        }
        .btn:hover {
            background: #FFDC00;
            color: #000;
            box-shadow: 0 0 30px rgba(255, 220, 0, 0.8);
        }
        
        /* ランク一覧スタイル */
        #rank-list-container {
            width: 90%;
            max-width: 400px;
            background: rgba(0,0,0,0.6);
            border: 1px solid #555;
            border-radius: 15px;
            padding: 15px;
            margin: 20px 0;
            max-height: 50vh;
            overflow-y: auto;
            text-align: left;
        }
        .rank-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 10px;
            border-bottom: 1px solid #333;
            font-size: 14px;
            color: #888;
        }
        .rank-item.active {
            color: #FFDC00;
            background: rgba(255, 220, 0, 0.15);
            font-weight: bold;
            border: 1px solid #FFDC00;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(255, 220, 0, 0.2) inset;
        }
        .rank-score {
            font-family: monospace;
            width: 70px;
            text-align: right;
        }
        .rank-name {
            flex-grow: 1;
            padding-left: 10px;
        }
        .rank-arrow {
            width: 60px;
            color: #FF4136;
            font-weight: bold;
            font-size: 12px;
            text-align: right;
            animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0; } }

        .hidden { display: none !important; }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-layer">
        <div id="top-area">
            <div id="hint-btn" onclick="game.toggleHint()">?</div>
            <div id="hint-overlay">Hint: 5 + 3</div>

            <div id="time-bar-wrapper">
                <div id="time-bar"></div>
            </div>

            <div id="target-label">TARGET MISSION</div>
            <div id="target-display">??</div>
            <div id="status-bar">
                <span id="score-display">SCORE: 0</span>
                <span id="timer-display">TIME: 120</span>
            </div>
            
            <div id="fever-label">FEVER GAUGE</div>
            <div id="fever-gauge-container">
                <div id="fever-gauge"></div>
            </div>
        </div>
        
        <div style="flex-grow: 1;"></div>

        <div id="bottom-area">
            <div id="guide-msg">TARGET: [数字]</div>
            <div id="formula-bar">READY...</div>
            
            <div id="btn-group">
                <div id="reset-btn" onclick="game.clearFormula()">RESET</div>
                <div id="fire-btn" onclick="game.fire()">FIRE</div>
            </div>
        </div>
    </div>

    <div id="menu-screen">
        <h1>BUBBLE SHOT</h1>
        <p style="color:#ccc; font-size:14px; line-height:1.6;">
            数字と記号のバブルをロックして<br>お題の数字を作り出せ！<br>
            <span style="color:#FF4136; font-size:12px;">(単発10点 / コンボ高得点 / 割算は切り捨て)</span>
        </p>
        <button class="btn" onclick="game.start()">GAME START</button>
    </div>

    <div id="gameover-screen" class="hidden">
        <h1 style="color:#FF4136;">MISSION OVER</h1>
        <p id="result-score" style="color:white; font-size:32px; font-weight:bold; margin:0 0 10px 0;">Score: 0</p>
        
        <div id="rank-list-container">
            </div>

        <button class="btn" onclick="location.reload()">RETRY</button>
    </div>
</div>

<script>
const OPS = {
    add: { label: '足', op: '+' },
    sub: { label: '引', op: '-' },
    mul: { label: '掛', op: '×' },
    div: { label: '割', op: '÷' }
};

const FEVER_TYPES = [
    { id: 'asc', label: '小さい順に撃て！ (昇順)' },
    { id: 'desc', label: '大きい順に撃て！ (降順)' },
    { id: 'even', label: '偶数を撃て！ (2, 4, 6...)' },
    { id: 'odd', label: '奇数を撃て！ (1, 3, 5...)' }
];

const RANKS = [
    { min: 30000, name: "伝説のゴッドエビ" },
    { min: 20000, name: "オマール海老級" },
    { min: 10000, name: "伊勢エビ級" },
    { min: 6000, name: "ブラックタイガー級" },
    { min: 3000, name: "甘エビ級" },
    { min: 1000, name: "サクラエビ級" },
    { min: 0,     name: "ミジンコ級" }
];

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        
        setTimeout(() => this.resize(), 100);
        window.addEventListener('resize', () => this.resize());

        this.state = 'menu';
        this.score = 0;
        this.maxTime = 120;
        this.timeLeft = this.maxTime;
        this.targetNum = 0;
        
        this.entities = [];
        this.formulaStack = [];
        this.clearCount = 0;

        this.feverTimer = 0;
        this.feverType = null;
        this.hintVisible = false;

        this.effects = [];
        this.radarRadius = 0;
        this.centerX = 0;
        this.centerY = 0;
        this.lastTime = 0;

        this.canvas.addEventListener('pointerdown', (e) => this.handleClick(e));
        
        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);
    }

    resize() {
        const dpr = window.devicePixelRatio || 1;
        this.width = window.innerWidth;
        this.height = window.innerHeight;
        this.canvas.width = this.width * dpr;
        this.canvas.height = this.height * dpr;
        this.canvas.style.width = this.width + 'px';
        this.canvas.style.height = this.height + 'px';
        this.ctx.scale(dpr, dpr);

        const topSpace = 180; 
        const bottomSpace = 180; 
        const availableHeight = this.height - topSpace - bottomSpace;
        
        this.centerY = topSpace + (availableHeight / 2);
        this.centerX = this.width / 2;
        const maxRadius = Math.min(this.width, availableHeight) / 2;
        this.radarRadius = Math.max(0, maxRadius - 10);
    }

    start() {
        this.resize();
        this.state = 'playing';
        this.score = 0;
        this.timeLeft = this.maxTime;
        this.clearCount = 0;
        this.updateGauge();
        this.updateTimeBar();

        this.formulaStack = [];
        this.entities = [];
        this.effects = [];
        this.hideHint();
        
        const count = (this.width < 400) ? 14 : 20;
        this.replenishEntities(count);

        this.generateTarget();
        this.updateUI();
        this.clearFormula();
        
        document.body.classList.remove('fever-mode');
        document.getElementById('menu-screen').classList.add('hidden');
        document.getElementById('gameover-screen').classList.add('hidden');
    }

    generateTarget() {
        this.targetNum = Math.floor(Math.random() * 31);
        document.getElementById('target-display').innerText = this.targetNum;
        document.getElementById('target-label').innerText = "TARGET MISSION";
        this.addEffect({type: 'text', text: 'TARGET UPDATED', color: '#FFDC00', size: 20});
        this.hideHint(); // 新しいお題になったらヒントを消す
    }

    replenishEntities(targetCount) {
        let currentCount = this.entities.length;
        let needed = targetCount - currentCount;
        for (let i = 0; i < needed; i++) {
            this.spawnEntity(false);
        }
    }

    spawnEntity(isFever) {
        const r = (this.width < 400) ? 22 : 28; 
        let x, y, safe = false, attempts = 0;
        const maxAttempts = 150; 
        
        while (!safe && attempts < maxAttempts) {
            attempts++;
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.sqrt(Math.random()) * (this.radarRadius - r - 5);
            x = this.centerX + Math.cos(angle) * dist;
            y = this.centerY + Math.sin(angle) * dist;
            
            safe = true;
            for (let ent of this.entities) {
                const d = Math.hypot(ent.x - x, ent.y - y);
                if (d < r * 2.2) { safe = false; break; }
            }
        }
        
        if (!safe) return;

        if (isFever) {
            const val = Math.floor(Math.random() * 20); 
            this.entities.push({ type: 'num', val: val, x: x, y: y, r: r, selected: false, isFever: true });
        } else {
            if (Math.random() < 0.5) {
                const val = Math.floor(Math.random() * 20); 
                this.entities.push({ type: 'num', val: val, x: x, y: y, r: r, selected: false });
            } else {
                const keys = Object.keys(OPS);
                const key = keys[Math.floor(Math.random() * keys.length)];
                this.entities.push({ type: 'op', val: key, x: x, y: y, r: r, selected: false });
            }
        }
    }

    startFever() {
        this.state = 'fever';
        this.feverTimer = 10;
        document.body.classList.add('fever-mode');
        this.entities = [];
        this.formulaStack = [];
        this.feverType = FEVER_TYPES[Math.floor(Math.random() * FEVER_TYPES.length)];
        this.hideHint();
        
        document.getElementById('target-display').innerText = "FEVER!!";
        document.getElementById('target-label').innerText = this.feverType.label;
        document.getElementById('guide-msg').innerText = this.feverType.label;
        document.getElementById('guide-msg').style.color = "#FF4136";
        document.getElementById('formula-bar').innerText = "TAP RED BUBBLES!";
        
        for(let i=0; i<20; i++) {
            this.spawnEntity(true);
        }
        this.addEffect({type: 'text', text: 'FEVER START!!', color: '#FF4136', size: 40});
    }

    endFever() {
        this.state = 'playing';
        document.body.classList.remove('fever-mode');
        this.entities = [];
        this.clearCount = 0;
        this.updateGauge();
        const count = (this.width < 400) ? 14 : 20;
        this.replenishEntities(count);
        this.generateTarget();
        this.clearFormula();
    }

    updateGauge() {
        const pct = Math.min(100, (this.clearCount / 3) * 100);
        document.getElementById('fever-gauge').style.width = `${pct}%`;
    }
    
    updateTimeBar() {
        const pct = Math.max(0, (this.timeLeft / this.maxTime) * 100);
        const bar = document.getElementById('time-bar');
        bar.style.width = `${pct}%`;
        if (pct < 20) bar.style.backgroundColor = '#FF4136'; 
        else if (pct < 50) bar.style.backgroundColor = '#FFDC00'; 
        else bar.style.backgroundColor = '#0074D9'; 
    }

    // --- ヒント機能 ---
    toggleHint() {
        if (this.hintVisible) {
            this.hideHint();
        } else {
            this.showHint();
        }
    }

    hideHint() {
        this.hintVisible = false;
        document.getElementById('hint-overlay').classList.remove('show');
    }

    showHint() {
        if (this.state !== 'playing') return;

        // スマートヒント: 画面上の数字から2手で解ける組み合わせを探す
        // 単純に [Num] [Op] [Num] = Target になるものを探す
        const nums = this.entities.filter(e => e.type === 'num');
        const ops = this.entities.filter(e => e.type === 'op');
        
        let hintText = "Try combining numbers!";
        
        // 総当たりで探す
        let found = false;
        for (let n1 of nums) {
            for (let n2 of nums) {
                if (n1 === n2) continue; // 同じバブルは使えない
                if (n1.val + n2.val === this.targetNum) {
                    hintText = `Try: ${n1.val} + ${n2.val}`; found = true; break;
                }
                if (n1.val - n2.val === this.targetNum) {
                    hintText = `Try: ${n1.val} - ${n2.val}`; found = true; break;
                }
                if (n1.val * n2.val === this.targetNum) {
                    hintText = `Try: ${n1.val} × ${n2.val}`; found = true; break;
                }
                if (n2.val !== 0 && Math.floor(n1.val / n2.val) === this.targetNum) {
                    hintText = `Try: ${n1.val} ÷ ${n2.val}`; found = true; break;
                }
            }
            if (found) break;
        }

        if (!found) {
            // 見つからない場合は汎用ヒント
            hintText = "Use more bubbles!";
        }

        const overlay = document.getElementById('hint-overlay');
        overlay.innerText = hintText;
        overlay.classList.add('show');
        this.hintVisible = true;
    }

    addEffect({type, text, x, y, color, size, life}) {
        if (x === undefined) x = this.centerX + (Math.random() * 80 - 40);
        if (y === undefined) y = this.centerY + (Math.random() * 80 - 40);
        
        this.effects.push({
            type: type || 'text',
            text: text,
            x: x,
            y: y,
            color: color || '#FFF',
            size: size || 20,
            life: life || 50
        });
    }

    handleClick(e) {
        const rect = this.canvas.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;

        // ヒントボタン判定はHTML側でonclick処理しているので、キャンバスのタップのみ処理
        for (let i = 0; i < this.entities.length; i++) {
            const ent = this.entities[i];
            const dist = Math.hypot(ent.x - clickX, ent.y - clickY);
            if (dist < ent.r + 15) {
                if (this.state === 'playing') {
                    this.trySelectNormal(ent);
                } else if (this.state === 'fever') {
                    this.trySelectFever(ent, i);
                }
                return;
            }
        }
    }

    trySelectFever(ent, index) {
        let isValid = false;
        const allVals = this.entities.map(e => e.val);
        
        if (this.feverType.id === 'asc') {
            const minVal = Math.min(...allVals);
            if (ent.val === minVal) isValid = true;
        } else if (this.feverType.id === 'desc') {
            const maxVal = Math.max(...allVals);
            if (ent.val === maxVal) isValid = true;
        } else if (this.feverType.id === 'even') {
            if (ent.val % 2 === 0) isValid = true;
        } else if (this.feverType.id === 'odd') {
            if (ent.val % 2 !== 0) isValid = true;
        }

        if (isValid) {
            this.score += 500;
            this.addEffect({text: '+500', x: ent.x, y: ent.y, color: '#FFDC00'});
            this.entities.splice(index, 1);
            // フィーバー中は補充しない（修正点）
            // this.spawnEntity(true); 
        } else {
            this.addEffect({text: 'MISS', x: ent.x, y: ent.y, color: '#888'});
        }
        this.updateUI();
    }

    trySelectNormal(ent) {
        if (ent.selected) return;
        const lastItem = this.formulaStack[this.formulaStack.length - 1];
        
        if (!lastItem) {
            if (ent.type !== 'num') { this.addEffect({text: "最初は数字！", x: ent.x, y: ent.y, color: '#FF4136'}); return; }
        } else {
            if (lastItem.entity.type === 'num' && ent.type === 'num') { this.addEffect({text: "次は記号！", x: ent.x, y: ent.y, color: '#FF4136'}); return; }
            if (lastItem.entity.type === 'op' && ent.type === 'op') { this.addEffect({text: "次は数字！", x: ent.x, y: ent.y, color: '#FF4136'}); return; }
        }

        ent.selected = true;
        ent.order = this.formulaStack.length + 1;
        this.formulaStack.push({ entity: ent });
        this.addEffect({text: 'LOCK', x: ent.x, y: ent.y - 30, color: '#00FFFF', life: 15, size: 14});
        this.updateFormulaBar();
        this.updateGuide();
        this.checkFireReady();
    }

    clearFormula() {
        this.entities.forEach(e => { e.selected = false; e.order = null; });
        this.formulaStack = [];
        this.updateFormulaBar();
        this.updateGuide();
        this.checkFireReady();
    }

    updateFormulaBar() {
        const bar = document.getElementById('formula-bar');
        if (this.formulaStack.length === 0) {
            bar.innerText = "(ターゲットをタップ)";
            bar.style.color = "#555";
            return;
        }

        let displayStr = "";
        
        if (this.formulaStack.length >= 1) {
            displayStr = `${this.formulaStack[0].entity.val}`;
        }

        for (let i = 1; i < this.formulaStack.length; i += 2) {
            const opEnt = this.formulaStack[i].entity;
            const opStr = OPS[opEnt.val].op;

            if (i + 1 < this.formulaStack.length) {
                const numEnt = this.formulaStack[i+1].entity;
                displayStr = `(${displayStr} ${opStr} ${numEnt.val})`;
            } else {
                displayStr = `${displayStr} ${opStr} ?`;
            }
        }

        bar.innerText = displayStr;
        bar.style.color = "#00FFFF";
    }

    updateGuide() {
        const msg = document.getElementById('guide-msg');
        if (this.state === 'fever') return;

        if (this.formulaStack.length === 0) {
            msg.innerText = "TARGET: [数字]";
            msg.style.color = "#FFDC00";
        } else {
            const last = this.formulaStack[this.formulaStack.length-1].entity;
            if (last.type === 'num') {
                msg.innerText = "TARGET: [記号]";
                msg.style.color = "#2ECC40";
            } else {
                msg.innerText = "TARGET: [数字]";
                msg.style.color = "#FFDC00";
            }
        }
    }

    checkFireReady() {
        const btn = document.getElementById('fire-btn');
        const len = this.formulaStack.length;
        if (len >= 1 && this.formulaStack[len-1].entity.type === 'num') {
            btn.classList.add('ready');
        } else {
            btn.classList.remove('ready');
        }
    }

    fire() {
        if (this.state !== 'playing' || this.formulaStack.length === 0) return;
        if (this.formulaStack[this.formulaStack.length-1].entity.type === 'op') {
            this.addEffect({text: "最後は数字で！", color: '#FF4136'}); return;
        }

        let result = this.formulaStack[0].entity.val;
        let scoreBonus = 0;
        
        for (let i = 1; i < this.formulaStack.length; i += 2) {
            const op = this.formulaStack[i].entity.val;
            const num = this.formulaStack[i+1].entity.val;

            if (op === 'add') result += num;
            else if (op === 'sub') result -= num;
            else if (op === 'mul') { result *= num; scoreBonus += 300; }
            else if (op === 'div') {
                if (num === 0) result = -9999;
                else result = Math.floor(result / num);
                scoreBonus += 500;
            }
        }

        if (Math.round(result) === this.targetNum) {
            const len = this.formulaStack.length;
            let totalScore = 0;

            if (len === 1) {
                totalScore = 10;
            } else {
                let multiplier = 1.0;
                if (len >= 5) multiplier = 1.5;
                if (len >= 7) multiplier = 2.5;
                const baseScore = len * 100;
                totalScore = Math.floor((baseScore + scoreBonus) * multiplier);
            }
            
            this.score += totalScore;
            this.addEffect({text: `HIT!! +${totalScore}`, color: '#FFDC00', size: 40});
            
            this.clearCount++;
            this.updateGauge();

            if (this.clearCount >= 3) {
                this.startFever();
            } else {
                this.generateTarget();
                this.entities = this.entities.filter(e => !e.selected);
                const count = (this.width < 400) ? 14 : 20;
                this.replenishEntities(count);
            }

        } else {
            this.addEffect({text: `MISS (${Math.round(result)})`, color: '#888', size: 30});
            this.entities.forEach(e => { e.selected = false; e.order = null; });
        }

        this.formulaStack = [];
        this.updateFormulaBar();
        this.updateGuide();
        this.checkFireReady();
        this.updateUI();
    }

    updateUI() {
        document.getElementById('score-display').innerText = `SCORE: ${this.score}`;
        document.getElementById('timer-display').innerText = `TIME: ${Math.floor(this.timeLeft)}`;
    }

    update(dt) {
        if (this.state === 'playing') {
            this.timeLeft -= dt;
            this.updateTimeBar();
            if (this.timeLeft <= 0) this.gameOver();
        } else if (this.state === 'fever') {
            this.feverTimer -= dt;
            document.getElementById('timer-display').innerText = `FEVER: ${Math.ceil(this.feverTimer)}`;
            if (this.feverTimer <= 0) {
                this.endFever();
            }
        }

        for (let i = this.effects.length - 1; i >= 0; i--) {
            let eff = this.effects[i];
            eff.y -= 0.5;
            eff.life--;
            if (eff.life <= 0) this.effects.splice(i, 1);
        }
    }
    
    gameOver() {
        this.state = 'gameover';
        document.getElementById('gameover-screen').classList.remove('hidden');
        document.getElementById('result-score').innerText = `Score: ${this.score}`;
        
        const container = document.getElementById('rank-list-container');
        container.innerHTML = ''; 
        
        let playerRankFound = false;

        RANKS.forEach(rank => {
            const div = document.createElement('div');
            div.className = 'rank-item';
            
            let isMyRank = false;
            if (!playerRankFound && this.score >= rank.min) {
                isMyRank = true;
                playerRankFound = true; 
                div.classList.add('active');
            }

            div.innerHTML = `
                <div class="rank-name">${rank.name}</div>
                <div class="rank-score">${rank.min}</div>
                <div class="rank-arrow">${isMyRank ? '◀ YOU' : ''}</div>
            `;
            container.appendChild(div);
        });
    }

    draw() {
        this.ctx.fillStyle = '#050510';
        this.ctx.fillRect(0, 0, this.width, this.height);

        const isFever = (this.state === 'fever');
        this.ctx.strokeStyle = isFever ? 'rgba(255, 0, 0, 0.5)' : 'rgba(0, 255, 255, 0.2)';
        this.ctx.lineWidth = 2;
        this.ctx.beginPath();
        this.ctx.arc(this.centerX, this.centerY, this.radarRadius, 0, Math.PI*2);
        this.ctx.stroke();
        
        const time = Date.now() / 1000;
        this.ctx.fillStyle = isFever ? 'rgba(255, 0, 0, 0.1)' : 'rgba(0, 255, 255, 0.05)';
        this.ctx.beginPath();
        this.ctx.moveTo(this.centerX, this.centerY);
        this.ctx.arc(this.centerX, this.centerY, this.radarRadius, time * (isFever?3:1), time * (isFever?3:1) + 0.5);
        this.ctx.fill();

        if (this.formulaStack.length > 0) {
            this.ctx.strokeStyle = '#00FFFF';
            this.ctx.lineWidth = 3;
            this.ctx.shadowBlur = 10;
            this.ctx.shadowColor = '#00FFFF';
            this.ctx.beginPath();
            const first = this.formulaStack[0].entity;
            this.ctx.moveTo(first.x, first.y);
            for (let i = 1; i < this.formulaStack.length; i++) {
                const next = this.formulaStack[i].entity;
                this.ctx.lineTo(next.x, next.y);
            }
            this.ctx.stroke();
            this.ctx.shadowBlur = 0;
        }

        this.entities.forEach(ent => {
            if (ent.isFever) {
                this.ctx.fillStyle = '#FF4136';
            } else if (ent.type === 'num') {
                this.ctx.fillStyle = ent.selected ? '#FFDC00' : '#EEE';
            } else {
                this.ctx.fillStyle = ent.selected ? '#FFDC00' : '#888';
            }
            
            this.ctx.beginPath();
            this.ctx.arc(ent.x, ent.y, ent.r, 0, Math.PI*2);
            this.ctx.fill();
            
            this.ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            this.ctx.beginPath();
            this.ctx.ellipse(ent.x - ent.r * 0.3, ent.y - ent.r * 0.3, ent.r * 0.2, ent.r * 0.1, Math.PI / 4, 0, Math.PI * 2);
            this.ctx.fill();

            if (ent.selected) {
                this.ctx.strokeStyle = '#00FFFF';
                this.ctx.lineWidth = 3;
                this.ctx.stroke();
                if (ent.order) {
                    this.ctx.fillStyle = '#FF4136';
                    this.ctx.beginPath();
                    this.ctx.arc(ent.x + 12, ent.y - 12, 8, 0, Math.PI*2);
                    this.ctx.fill();
                    this.ctx.fillStyle = '#fff';
                    this.ctx.fillText(ent.order, ent.x + 12, ent.y - 12);
                }
            } else if (ent.isFever) {
                this.ctx.strokeStyle = '#FF0000';
                this.ctx.lineWidth = 2;
                this.ctx.stroke();
            }

            this.ctx.fillStyle = '#000';
            this.ctx.textAlign = 'center';
            this.ctx.textBaseline = 'middle';
            this.ctx.font = ent.r > 22 ? 'bold 22px Arial' : 'bold 16px Arial';
            let label = ent.type === 'num' ? ent.val : OPS[ent.val].label;
            this.ctx.fillText(label, ent.x, ent.y);
        });

        this.effects.forEach(eff => {
            this.ctx.fillStyle = eff.color;
            this.ctx.font = `bold ${eff.size || 20}px Arial`;
            this.ctx.fillText(eff.text, eff.x, eff.y);
        });
    }

    loop(timestamp) {
        const dt = (timestamp - this.lastTime) / 1000;
        this.lastTime = timestamp;
        this.update(dt);
        this.draw();
        requestAnimationFrame(this.loop);
    }
}

window.onload = () => {
    window.game = new Game();
};
</script>
</body>
</html>
