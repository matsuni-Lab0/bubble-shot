<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bubble Shot: Hi-MAT Targeting</title>
    <style>
        /* --- CSS: 重厚なコックピット風UI --- */
        body {
            margin: 0; overflow: hidden; background-color: #020205; color: white;
            font-family: 'Segoe UI', sans-serif;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }
        #game-container {
            position: relative; width: 100vw; height: 100dvh; overflow: hidden;
            background: radial-gradient(circle at center, #1a1a2e 0%, #000000 100%);
        }
        canvas { display: block; width: 100%; height: 100%; }

        /* UIレイヤー */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }

        /* ヘッダーエリア */
        #top-hud {
            display: flex; justify-content: space-between; align-items: flex-start;
            padding: 15px;
            background: linear-gradient(to bottom, rgba(0, 50, 100, 0.8), transparent);
        }

        /* 司令官通信ウィンドウ */
        #comm-window {
            width: 70px; height: 70px;
            border: 2px solid #00FFFF; border-radius: 50%;
            background: rgba(0, 20, 30, 0.7);
            box-shadow: 0 0 15px #00FFFF;
            display: flex; justify-content: center; align-items: center;
            overflow: hidden; position: relative;
        }
        #comm-scanline {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to bottom, transparent 50%, rgba(0,255,255,0.1) 51%);
            background-size: 100% 4px; pointer-events: none;
        }

        /* スコア・タイム */
        #status-panel { text-align: right; }
        .hud-label { font-size: 10px; color: #00FFFF; letter-spacing: 2px; text-shadow: 0 0 5px #00FFFF; }
        .hud-value { font-size: 24px; font-weight: bold; font-family: 'Courier New', monospace; color: #fff; }

        /* ミッション表示（画面中央上） */
        #mission-hud {
            position: absolute; top: 90px; width: 100%; text-align: center; pointer-events: none;
        }
        #mission-title {
            font-size: 36px; font-weight: 900; color: #FFD700;
            text-shadow: 0 0 20px #FFD700; letter-spacing: 3px;
            font-family: 'Arial Black', sans-serif;
            transition: transform 0.1s;
        }
        #mission-desc {
            font-size: 14px; color: #fff; background: rgba(0,0,0,0.6);
            padding: 4px 12px; border-radius: 4px; display: inline-block;
            border: 1px solid #555; margin-top: 5px;
        }
        .pulse-text { animation: pulse 0.8s infinite alternate; }
        @keyframes pulse { from { opacity: 1; transform: scale(1); } to { opacity: 0.8; transform: scale(0.95); } }

        /* フッターエリア（FIREボタン） */
        #bottom-hud {
            padding: 20px; display: flex; justify-content: center; align-items: flex-end;
            background: linear-gradient(to top, rgba(0, 20, 30, 0.9), transparent);
            pointer-events: auto;
        }

        #fire-btn {
            width: 200px; height: 70px;
            background: rgba(255, 0, 60, 0.2);
            border: 2px solid #FF003C;
            color: #FF003C;
            font-size: 28px; font-weight: 900; letter-spacing: 5px;
            display: flex; justify-content: center; align-items: center;
            clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            cursor: pointer; transition: all 0.1s;
            box-shadow: 0 0 20px rgba(255, 0, 60, 0.4);
            text-shadow: 0 0 10px #FF003C;
        }
        #fire-btn:active {
            background: #FF003C; color: #fff; transform: scale(0.95);
            box-shadow: 0 0 40px #FF003C;
        }
        #fire-btn.disabled {
            filter: grayscale(100%); opacity: 0.5; pointer-events: none;
        }

        #auto-lock-sub {
            position: absolute; bottom: 30px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            border: 2px solid #00FF00; color: #00FF00;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 10px; font-weight: bold; background: rgba(0, 255, 0, 0.1);
            cursor: pointer; pointer-events: auto; box-shadow: 0 0 10px #00FF00;
        }
        #auto-lock-sub:active { transform: scale(0.9); background: #00FF00; color: #000; }

        /* タイムバー */
        #time-gauge {
            position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: #333;
        }
        #time-fill {
            width: 100%; height: 100%; background: #00FFFF;
            box-shadow: 0 0 10px #00FFFF; transition: width 0.1s linear;
        }

        /* スタート画面 */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 50;
        }
        .title-text {
            font-size: 40px; color: #00FFFF; font-weight: 900;
            text-shadow: 0 0 20px #00FFFF; margin-bottom: 10px; text-align: center;
            font-family: 'Arial Black', sans-serif;
        }
        .start-btn {
            padding: 15px 50px; border: 2px solid #FFD700; color: #FFD700;
            background: transparent; font-size: 20px; font-weight: bold;
            cursor: pointer; box-shadow: 0 0 15px #FFD700; margin-top: 30px;
        }
        .hidden { display: none !important; }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>

    <div id="ui-layer">
        <div id="time-gauge"><div id="time-fill"></div></div>

        <div id="top-hud">
            <div id="comm-window">
                <canvas id="comm-canvas" width="70" height="70"></canvas>
                <div id="comm-scanline"></div>
            </div>
            <div id="status-panel">
                <div class="hud-label">SCORE</div>
                <div class="hud-value" id="score-val">00000</div>
                <div class="hud-label">TIME</div>
                <div class="hud-value" id="time-val">60</div>
            </div>
        </div>

        <div id="mission-hud">
            <div id="mission-title" class="pulse-text">ODD NUMS</div>
            <div id="mission-desc">奇数(1,3,5...)をロックして撃て</div>
        </div>

        <div id="bottom-hud">
            <div id="fire-btn" onclick="game.fire()">FIRE</div>
            <div id="auto-lock-sub" onclick="game.autoLock()">
                MAP<br>WPN
            </div>
        </div>
    </div>

    <div id="start-overlay">
        <div class="title-text">Hi-MAT<br>TARGETING</div>
        <div style="color:#ccc; font-size:14px;">Tap to Lock-on > Press FIRE</div>
        <button class="start-btn" onclick="game.start()">LAUNCH</button>
    </div>
</div>

<script>
/**
 * Bubble Shot Ver 4.1: Hi-MAT TARGETING
 * 操作：タップでロックオン（複数選択可） → FIREボタンで発射
 * ルール：反射神経（奇数・偶数）＋ボス（計算）
 */

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.commCanvas = document.getElementById('comm-canvas');
        this.commCtx = this.commCanvas.getContext('2d');

        this.resize();
        window.addEventListener('resize', () => this.resize());

        // 入力：タップのみ（ドラッグではない）
        this.canvas.addEventListener('pointerdown', (e) => this.handleTap(e));

        // 状態
        this.state = 'menu'; 
        this.score = 0;
        this.maxTime = 60;
        this.timeLeft = 60;
        
        this.bubbles = [];
        this.lasers = [];
        this.particles = [];
        this.texts = [];
        
        this.mission = null; // 現在の任務
        this.combo = 0; // ルール変更用

        // ループ
        this.lastTime = 0;
        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);

        this.drawCommander('normal');
    }

    resize() {
        this.dpr = window.devicePixelRatio || 1;
        this.width = window.innerWidth;
        this.height = window.innerHeight;
        this.canvas.width = this.width * this.dpr;
        this.canvas.height = this.height * this.dpr;
        this.ctx.scale(this.dpr, this.dpr);
        this.bubbleR = Math.min(this.width, this.height) / 8;
    }

    start() {
        document.getElementById('start-overlay').classList.add('hidden');
        this.state = 'playing';
        this.score = 0;
        this.timeLeft = this.maxTime;
        this.bubbles = [];
        this.replenishBubbles(15);
        this.setNextMission();
        this.updateUI();
    }

    // --- ミッション管理 ---
    setNextMission() {
        const rules = [
            { id: 'odd', title: 'ODD', desc: '奇数 (1,3,5...) をロックせよ', color: '#FF0055' },
            { id: 'even', title: 'EVEN', desc: '偶数 (2,4,6...) をロックせよ', color: '#00CCFF' },
            { id: 'asc', title: 'ASCEND', desc: '小さい順 (1→2→3) にロックせよ', color: '#00FF00' },
            { id: 'desc', title: 'DESCEND', desc: '大きい順 (9→8→7) にロックせよ', color: '#FFCC00' }
        ];

        // 低確率でボス（計算ミッション）
        if (Math.random() < 0.25 && this.score > 500) {
            this.setBossMission();
            return;
        }

        let next;
        do { next = rules[Math.floor(Math.random()*rules.length)]; } 
        while(this.mission && this.mission.id === next.id);
        
        this.mission = next;
        this.updateMissionUI();
        this.drawCommander('normal');
    }

    setBossMission() {
        const targets = [
            { t: 6, op: 'mul', title: 'TARGET: 6', desc: '掛け算で作れ (2×3)' },
            { t: 12, op: 'mul', title: 'TARGET: 12', desc: '掛け算で作れ (3×4)' },
            { t: 10, op: 'add', title: 'TARGET: 10', desc: '足し算で作れ (5+5)' }
        ];
        const t = targets[Math.floor(Math.random()*targets.length)];
        this.mission = { id: 'calc', title: t.title, desc: t.desc, targetVal: t.t, targetOp: t.op, color: '#FFFFFF' };
        
        this.updateMissionUI();
        this.drawCommander('panic');
        this.ensureBossSolvable();
    }

    updateMissionUI() {
        const t = document.getElementById('mission-title');
        const d = document.getElementById('mission-desc');
        t.innerText = this.mission.title;
        t.style.color = this.mission.color;
        d.innerText = this.mission.desc;
        t.classList.remove('pulse-text');
        void t.offsetWidth;
        t.classList.add('pulse-text');
    }

    // --- 入力処理（タップでロックオン） ---
    handleTap(e) {
        if (this.state !== 'playing') return;
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;

        // タップした場所にあるバブルを探す
        for (let b of this.bubbles) {
            const dist = Math.hypot(b.x - x, b.y - y);
            if (dist < b.r * 1.2) {
                // 選択状態のトグル（ON/OFF）
                b.selected = !b.selected;
                if (b.selected) {
                    // 選択時の音エフェクト的な振動
                    b.scale = 1.3;
                    // 昇順・降順のチェック順序記録用
                    b.selectTime = Date.now();
                }
                break; // 重なり防止
            }
        }
    }

    // --- 発射処理 ---
    fire() {
        if (this.state !== 'playing') return;
        
        const selected = this.bubbles.filter(b => b.selected);
        if (selected.length === 0) return;

        // 昇順・降順は選択順序でソート
        if (this.mission.id === 'asc' || this.mission.id === 'desc' || this.mission.id === 'calc') {
            selected.sort((a,b) => a.selectTime - b.selectTime);
        }

        // 判定
        let success = false;
        let bonus = 0;

        if (this.mission.id === 'calc') {
            // 計算モード
            if (selected.length >= 3) {
                let exp = "";
                let hasOp = false;
                selected.forEach(b => {
                    let v = b.val;
                    if (v === '×') { v = '*'; if(this.mission.targetOp === 'mul') hasOp=true; }
                    if (v === '+') { if(this.mission.targetOp === 'add') hasOp=true; }
                    exp += v;
                });
                try {
                    if (new Function('return '+exp)() === this.mission.targetVal && hasOp) {
                        success = true;
                        bonus = 5000;
                    }
                } catch(e){}
            }
        } else {
            // 反射神経モード
            // 全てが条件を満たしているか？
            let allCorrect = true;
            let lastVal = -1;

            selected.forEach((b, i) => {
                if (b.type !== 'num') { allCorrect = false; return; }
                const v = b.val;

                if (this.mission.id === 'odd' && v % 2 === 0) allCorrect = false;
                if (this.mission.id === 'even' && v % 2 !== 0) allCorrect = false;
                
                if (this.mission.id === 'asc') {
                    if (i > 0 && v <= lastVal) allCorrect = false;
                    lastVal = v;
                }
                if (this.mission.id === 'desc') {
                    if (i > 0 && v >= lastVal) allCorrect = false;
                    lastVal = v;
                }
            });

            if (allCorrect && selected.length > 0) {
                success = true;
                bonus = selected.length * 200;
            }
        }

        if (success) {
            // 成功：フルバースト！
            this.triggerBurst(selected, this.mission.color);
            this.score += bonus;
            this.addText(this.width/2, this.height/2, `BURST! +${bonus}`, this.mission.color, 40);
            this.timeLeft = Math.min(this.maxTime, this.timeLeft + 1);
            this.drawCommander('happy');

            // ルール進行
            if (this.mission.id === 'calc') {
                this.setNextMission();
            } else {
                this.combo++;
                if (this.combo > 2) {
                    this.combo = 0;
                    this.setNextMission();
                }
            }
        } else {
            // 失敗
            selected.forEach(b => b.selected = false);
            this.addText(this.width/2, this.height/2, "MISS...", "#888");
            this.timeLeft -= 3;
            this.drawCommander('panic');
            // ダメージ演出
            document.body.style.backgroundColor = '#500';
            setTimeout(() => document.body.style.backgroundColor = '#020205', 100);
        }
    }

    autoLock() {
        if (this.state !== 'playing') return;
        
        // 条件に合うものを全検索してロック
        const targets = [];
        this.bubbles.forEach(b => {
            let match = false;
            if (this.mission.id === 'odd') match = (b.type === 'num' && b.val % 2 !== 0);
            else if (this.mission.id === 'even') match = (b.type === 'num' && b.val % 2 === 0);
            else if (this.mission.id === 'calc') match = true; // マップ兵器（全消し）
            else match = (b.type === 'num'); // 昇順などはとりあえず数字なら消す
            
            if (match) targets.push(b);
        });

        if (targets.length > 0) {
            this.triggerBurst(targets, '#00FF00');
            this.score += targets.length * 100;
            this.addText(this.width/2, this.height/2, "MAP ATTACK!", "#00FF00", 50);
            this.drawCommander('happy');
        }
    }

    triggerBurst(targets, color) {
        targets.forEach(b => {
            // レーザー
            this.lasers.push({ tx: b.x, ty: b.y, life: 1.0, color: color });
            // 爆発
            this.spawnParticles(b.x, b.y, color);
            // 消去
            const idx = this.bubbles.indexOf(b);
            if (idx > -1) this.bubbles.splice(idx, 1);
        });
        // 補充
        this.replenishBubbles(15 - this.bubbles.length);
    }

    // --- 汎用 ---
    replenishBubbles(count) {
        if (count <= 0) return;
        for(let i=0; i<count; i++) {
            let type = 'num';
            let val = Math.floor(Math.random()*9)+1;
            
            // 計算モード時は演算子も出す
            if (this.mission && this.mission.id === 'calc' && Math.random()<0.4) {
                type = 'op';
                val = ['+','×'][Math.floor(Math.random()*2)];
            }
            
            this.bubbles.push({
                x: Math.random() * (this.width - 60) + 30,
                y: Math.random() * (this.height - 250) + 150,
                r: this.bubbleR * 0.7,
                val: val, type: type,
                vx: (Math.random()-0.5)*1.5, vy: (Math.random()-0.5)*1.5,
                selected: false, scale: 1, selectTime: 0,
                color: type==='num' ? '#0074D9' : '#FF4136'
            });
        }
    }

    ensureBossSolvable() {
        // 計算に必要なパーツを追加
        const t = this.mission.targetVal;
        const op = this.mission.targetOp === 'mul' ? '×' : '+';
        this.bubbles.push(this.makeBubble(1, 'num'));
        this.bubbles.push(this.makeBubble(op, 'op'));
        this.bubbles.push(this.makeBubble(t, 'num'));
    }
    
    makeBubble(val, type) {
        return {
            x: this.width/2, y: this.height/2,
            r: this.bubbleR * 0.7, val: val, type: type,
            vx: (Math.random()-0.5)*2, vy: (Math.random()-0.5)*2,
            selected: false, scale: 1, selectTime: 0,
            color: type==='num' ? '#0074D9' : '#FF4136'
        };
    }

    spawnParticles(x, y, color) {
        for(let i=0; i<8; i++) {
            this.particles.push({
                x, y, vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10,
                life: 1.0, color
            });
        }
    }
    
    addText(x, y, text, color, size=20) {
        this.texts.push({ x, y, text, color, size, life: 1.0 });
    }

    drawCommander(mood) {
        const ctx = this.commCtx;
        ctx.clearRect(0,0,70,70);
        const x=35, y=35, s=28;
        ctx.fillStyle = mood==='panic'?'#A0A0FF':(mood==='happy'?'#FF4136':'#FFDB58');
        ctx.beginPath(); ctx.arc(x,y,s,0,Math.PI*2); ctx.fill();
        // 簡易顔（前回と同じ）
        ctx.fillStyle='#000'; 
        ctx.beginPath(); ctx.arc(x-8, y-5, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.arc(x+8, y-5, 3, 0, Math.PI*2); ctx.fill();
        ctx.beginPath();
        if(mood==='panic') { ctx.moveTo(x-10,y+10); ctx.lineTo(x+10,y+10); ctx.stroke(); }
        else { ctx.arc(x,y+5,10,0,Math.PI); ctx.fill(); }
    }

    // --- ループ ---
    loop() {
        if (this.state === 'playing') {
            this.timeLeft -= 1/60;
            if (this.timeLeft <= 0) {
                this.state = 'gameover';
                document.getElementById('start-overlay').classList.remove('hidden');
                document.querySelector('.title-text').innerText = "TIME UP";
                document.querySelector('.start-btn').innerText = "RETRY";
            }
            // UI更新
            document.getElementById('score-val').innerText = this.score.toString().padStart(5, '0');
            document.getElementById('time-val').innerText = Math.ceil(this.timeLeft);
            const pct = (this.timeLeft/this.maxTime)*100;
            document.getElementById('time-fill').style.width = pct + '%';
            if(pct<20) document.getElementById('time-fill').style.backgroundColor = '#FF0000';
        }

        // 描画
        this.ctx.fillStyle = '#020205';
        this.ctx.fillRect(0, 0, this.width, this.height);

        // レーザー
        this.ctx.globalCompositeOperation = 'lighter';
        for (let i = this.lasers.length - 1; i >= 0; i--) {
            let l = this.lasers[i];
            l.life -= 0.1;
            this.ctx.strokeStyle = l.color;
            this.ctx.lineWidth = 20 * l.life;
            this.ctx.lineCap = 'round';
            this.ctx.beginPath();
            this.ctx.moveTo(this.width/2, this.height);
            this.ctx.lineTo(l.tx, l.ty);
            this.ctx.stroke();
            this.ctx.lineWidth = 5 * l.life;
            this.ctx.strokeStyle = '#fff';
            this.ctx.stroke();
            if (l.life <= 0) this.lasers.splice(i, 1);
        }
        this.ctx.globalCompositeOperation = 'source-over';

        // バブル
        this.bubbles.forEach(b => {
            b.x += b.vx; b.y += b.vy;
            if (b.x < b.r || b.x > this.width-b.r) b.vx *= -1;
            if (b.y < 150 || b.y > this.height-100) b.vy *= -1;
            if (b.scale > 1) b.scale -= 0.05;

            // 本体
            this.ctx.fillStyle = b.color;
            this.ctx.beginPath();
            this.ctx.arc(b.x, b.y, b.r * b.scale, 0, Math.PI*2);
            this.ctx.fill();
            
            // ロックオンサイト（選択時）
            if (b.selected) {
                this.drawReticle(b.x, b.y, b.r * 1.3, this.mission.color);
                // 選択順序番号（計算モードのみ）
                if (this.mission.id === 'calc' || this.mission.id === 'asc' || this.mission.id === 'desc') {
                     // 簡易的なバッジ
                }
            }
            
            // 文字
            this.ctx.fillStyle = '#fff';
            this.ctx.font = 'bold 24px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.textBaseline = 'middle';
            this.ctx.fillText(b.val, b.x, b.y);
        });

        // エフェクト
        this.particles.forEach((p, i) => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.05;
            this.ctx.globalAlpha = p.life;
            this.ctx.fillStyle = p.color;
            this.ctx.beginPath(); this.ctx.arc(p.x, p.y, 4, 0, Math.PI*2); this.ctx.fill();
            this.ctx.globalAlpha = 1;
            if (p.life<=0) this.particles.splice(i,1);
        });

        this.texts.forEach((t, i) => {
            t.y -= 1; t.life -= 0.02;
            this.ctx.globalAlpha = t.life;
            this.ctx.fillStyle = t.color;
            this.ctx.font = `bold ${t.size}px Arial`;
            this.ctx.textAlign = 'center';
            this.ctx.fillText(t.text, t.x, t.y);
            this.ctx.globalAlpha = 1;
            if (t.life<=0) this.texts.splice(i,1);
        });

        requestAnimationFrame(this.loop);
    }

    drawReticle(x, y, r, color) {
        this.ctx.strokeStyle = color;
        this.ctx.lineWidth = 3;
        this.ctx.beginPath();
        this.ctx.arc(x, y, r, 0, Math.PI*2);
        this.ctx.stroke();
        
        // 回転パーツ
        this.ctx.save();
        this.ctx.translate(x, y);
        this.ctx.rotate(Date.now() / 150);
        this.ctx.beginPath();
        this.ctx.arc(0, 0, r * 0.8, 0, Math.PI*1.5);
        this.ctx.stroke();
        this.ctx.restore();
    }
}

window.game = new Game();
</script>
</body>
</html>
