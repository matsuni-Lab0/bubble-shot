<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bubble Shot: Hi-MAT Shrimp</title>
    <style>
        /* --- CSS設定 (Shrimp Edition Base) --- */
        body {
            margin: 0; overflow: hidden; background-color: #111; color: white;
            font-family: 'Helvetica Neue', 'Arial', sans-serif;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }
        #game-container {
            position: relative; width: 100vw; height: 100dvh; overflow: hidden;
            background-color: #050510;
        }
        canvas { display: block; width: 100%; height: 100%; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }

        /* --- 上部エリア --- */
        #top-area {
            height: 180px; display: flex; flex-direction: column; align-items: center;
            justify-content: flex-start; background: linear-gradient(to bottom, rgba(0,0,0,0.8), rgba(0,0,0,0));
            z-index: 10; padding-top: 10px; box-sizing: border-box; position: relative;
        }

        /* 司令官ウィンドウ */
        #commander-window {
            position: absolute; top: 10px; left: 10px;
            width: 70px; height: 70px;
            background: rgba(0, 20, 40, 0.6);
            border: 2px solid #00FFFF; border-radius: 10px;
            clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%);
            pointer-events: auto; display: flex; justify-content: center; align-items: center;
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.2);
            z-index: 25; backdrop-filter: blur(2px);
        }
        #comm-canvas { width: 100%; height: 100%; }
        #comm-label {
            position: absolute; bottom: 2px; right: 4px;
            font-size: 8px; color: #00FFFF; font-family: monospace; opacity: 0.8;
        }

        /* マニュアルリロード */
        #manual-shuffle-btn {
            position: absolute; top: 15px; left: 90px;
            width: 40px; height: 40px; border-radius: 50%;
            background: rgba(255, 165, 0, 0.1); border: 2px solid #FFA500;
            color: #FFA500; box-shadow: 0 0 10px rgba(255, 165, 0, 0.2); font-size: 18px;
            display: flex; justify-content: center; align-items: center;
            pointer-events: auto; cursor: pointer; z-index: 20;
            backdrop-filter: blur(4px);
        }
        #manual-shuffle-btn:active { transform: scale(0.9); }

        #difficulty-display {
            position: absolute; top: 20px; right: 15px;
            font-size: 12px; font-weight: bold; color: #888; letter-spacing: 1px;
            border: 1px solid #444; padding: 2px 6px; border-radius: 4px;
        }

        /* オートロックボタン (MAP兵器) */
        #auto-lock-btn {
            position: absolute; bottom: 100px; right: 20px;
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(255, 0, 255, 0.2); border: 2px solid #FF00FF; color: #FF00FF;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            font-size: 10px; font-weight: 900; text-align: center;
            box-shadow: 0 0 15px #FF00FF; cursor: pointer; pointer-events: auto; z-index: 30;
            animation: pulse 2s infinite; line-height: 1.1;
        }
        #auto-lock-btn.disabled { filter: grayscale(100%); opacity: 0.5; animation: none; pointer-events: none;} 

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(255, 0, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 0, 255, 0); }
        }

        #time-bar-wrapper {
            width: 50%; height: 6px; background: #222; border-radius: 4px;
            margin-top: 10px; border: 1px solid #555; position: relative; overflow: hidden;
        }
        #time-bar { width: 100%; height: 100%; background: #0074D9; transition: width 0.1s linear, background 0.3s; box-shadow: 0 0 10px currentColor; }
        
        #mission-label { font-size: 10px; color: #00FFFF; letter-spacing: 4px; margin-top: 5px; opacity: 0.8;}
        #mission-display {
            font-size: 32px; font-weight: 900; color: #FFDC00; line-height: 1.0; margin: 0;
            text-shadow: 0 0 20px rgba(255, 220, 0, 0.8); font-family: 'Arial Black', sans-serif; letter-spacing: -1px;
            transition: transform 0.1s;
        }
        .pulse-text { animation: textPulse 0.5s infinite alternate; }
        @keyframes textPulse { from { transform: scale(1); } to { transform: scale(1.1); } }

        #status-bar {
            color: #aaa; font-family: monospace; font-size: 16px; display: flex; gap: 20px;
            font-weight: bold; margin-top: 5px; text-shadow: 0 0 2px #000;
        }

        /* --- 下部エリア --- */
        #bottom-area {
            height: 180px; display: flex; flex-direction: column; align-items: center;
            justify-content: flex-end; padding-bottom: 30px;
            background: linear-gradient(to top, rgba(0,20,30,0.95) 60%, rgba(0,0,0,0)); z-index: 10;
        }
        #guide-msg {
            color: #00FFFF; font-size: 14px; margin-bottom: 5px; min-height: 35px;
            text-shadow: 0 0 5px #00FFFF; letter-spacing: 1px; text-align: center; line-height: 1.3;
        }
        #guide-msg .sub { font-size: 10px; color: #aaa; display: block; margin-top: 2px;}

        #formula-bar {
            min-height: 20px; margin-bottom: 10px; font-size: 18px; color: #FFF; font-family: monospace;
            font-weight: bold; text-shadow: 0 0 5px #00FFFF; white-space: nowrap;
        }
        #btn-group { display: flex; gap: 20px; align-items: center; }
        
        #fire-btn {
            width: 160px; height: 70px; background: rgba(255, 0, 60, 0.1); border: 2px solid #555;
            color: #555; font-size: 28px; font-weight: 900; letter-spacing: 4px; display: flex;
            justify-content: center; align-items: center; clip-path: polygon(10% 0, 100% 0, 100% 70%, 90% 100%, 0 100%, 0 30%);
            transition: all 0.1s; cursor: pointer; pointer-events: none;
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        #fire-btn.ready {
            background: rgba(255, 0, 60, 0.8); border: 2px solid #FF003C; color: white; box-shadow: 0 0 30px #FF003C;
            pointer-events: auto; text-shadow: 0 0 10px white;
        }
        #fire-btn:active { transform: scale(0.95); background: #fff; color: #FF003C; }

        /* --- 画面オーバーレイ --- */
        #menu-screen, #gameover-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 10, 15, 0.95); display: flex; flex-direction: column;
            justify-content: flex-start; align-items: center; pointer-events: auto; z-index: 50;
            text-align: center; box-sizing: border-box; padding: 40px 20px; overflow-y: auto;
        }
        #menu-screen { justify-content: center; }

        h1 { 
            color: #00FFFF; font-size: 36px; font-weight: 900; text-shadow: 0 0 10px #00FFFF, 0 0 30px #00FFFF; 
            margin: 10px 0; letter-spacing: 4px; font-style: italic; font-family: 'Arial Black', sans-serif;
        }
        
        .btn {
            padding: 15px 40px; font-size: 18px; background: transparent; border: 2px solid #FFDC00;
            color: #FFDC00; cursor: pointer; font-weight: bold; box-shadow: 0 0 10px #FFDC00, inset 0 0 10px #FFDC00;
            transition: all 0.2s; margin-top: 15px; text-transform: uppercase; letter-spacing: 2px;
            width: 100%; max-width: 300px;
        }
        .btn:hover { background: #FFDC00; color: #000; box-shadow: 0 0 30px #FFDC00; }

        /* 難易度選択ボタン */
        .diff-container {
            display: flex; flex-direction: column; gap: 15px; width: 100%; align-items: center; margin-bottom: 20px;
        }
        .btn-diff {
            width: 80%; padding: 12px; font-size: 16px; margin: 0;
            border-color: #00FFFF; color: #00FFFF; box-shadow: 0 0 5px #00FFFF;
        }
        .btn-diff:hover { background: #00FFFF; color: #000; }
        
        .btn-easy { border-color: #2ECC40; color: #2ECC40; box-shadow: 0 0 5px #2ECC40; }
        .btn-easy:hover { background: #2ECC40; }
        .btn-normal { border-color: #0074D9; color: #0074D9; box-shadow: 0 0 5px #0074D9; }
        .btn-normal:hover { background: #0074D9; }
        .btn-hard { border-color: #FF4136; color: #FF4136; box-shadow: 0 0 5px #FF4136; }
        .btn-hard:hover { background: #FF4136; }

        .rule-box {
            font-size: 14px; color: #ccc; line-height: 1.6; margin-bottom: 20px; text-align: left; display: inline-block;
        }
        .rule-box .en { color: #fff; font-weight: bold; display: block; margin-bottom: 2px;}
        .rule-box .ja { color: #888; font-size: 11px; display: block; margin-bottom: 10px;}
        
        #rank-list-container {
            width: 100%; max-width: 350px; margin-bottom: 20px; text-align: left; border-top: 1px solid #333; margin-top: 20px;
        }
        .rank-item {
            display: flex; justify-content: space-between; align-items: center; padding: 8px 5px; border-bottom: 1px solid #222; font-family: monospace;
        }
        .rank-item.active {
            color: #FFDC00; background: linear-gradient(90deg, transparent, rgba(255, 220, 0, 0.1), transparent);
            font-weight: bold; text-shadow: 0 0 5px #FFDC00;
        }
        .rank-name-col { flex-grow: 1; padding-left: 10px; display: flex; flex-direction: column;}
        .rank-name-en { font-size: 14px; color: #ccc; }
        .rank-name-ja { font-size: 10px; color: #666; }
        .active .rank-name-en { color: #FFDC00; }
        .active .rank-name-ja { color: #AA8800; }
        .rank-score { width: 60px; text-align: right; font-size: 14px; color: #888; }
        .rank-arrow { width: 40px; color: #FF4136; text-align: right; font-weight:bold; font-size: 12px; animation: blink 0.5s infinite alternate; }
        @keyframes blink { from { opacity: 1; } to { opacity: 0.3; } }
        .hidden { display: none !important; }

        #mascot-canvas-menu, #mascot-canvas-over { width: 100px; height: 100px; margin-bottom: 10px; }

    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    
    <div id="ui-layer">
        <div id="top-area">
            <div id="commander-window">
                <canvas id="comm-canvas" width="70" height="70"></canvas>
                <div id="comm-label">CMD</div>
            </div>

            <div id="manual-shuffle-btn" onclick="game.manualShuffle()">↻</div>
            <div id="difficulty-display">Lv.?</div>

            <div id="time-bar-wrapper"><div id="time-bar"></div></div>
            <div id="mission-label">MISSION</div>
            <div id="mission-display">READY</div>
            <div id="status-bar">
                <span id="score-display">SCORE: 0</span>
                <span id="timer-display">TIME: 60</span>
            </div>
        </div>
        
        <div style="flex-grow: 1;"></div>
        
        <div id="auto-lock-btn" onclick="game.autoLock()">
            <div class="trial-badge">MAP WPN</div>
            AUTO<br>LOCK
            <span class="ja-sub">全自動射撃</span>
        </div>

        <div id="bottom-area">
            <div id="guide-msg">
                TAP TO LOCK
                <span class="sub">ターゲットをタップせよ</span>
            </div>
            <div id="formula-bar"></div>
            <div id="btn-group">
                <div id="fire-btn" onclick="game.fire()">FIRE</div>
            </div>
        </div>
    </div>

    <div id="menu-screen">
        <canvas id="mascot-canvas-menu" width="100" height="100"></canvas>
        <h1>Hi-MAT SHRIMP</h1>
        <p style="color:#00FFFF; font-size:12px; margin-bottom: 20px; font-family: monospace;">
            SYSTEM: ONLINE<br>MODE: REFLEX TARGETING
        </p>
        <div class="rule-box">
            <span class="en">1. Check the MISSION (e.g., ODD).</span>
            <span class="ja">ミッションを確認 (例: 奇数)。</span>
            <span class="en">2. TAP bubbles to Multi-Lock.</span>
            <span class="ja">タップして複数をロックオン。</span>
            <span class="en">3. Press FIRE to Burst!</span>
            <span class="ja">FIREボタンで一斉発射！</span>
        </div>
        <div class="diff-container">
            <button class="btn btn-diff btn-easy" onclick="game.start('easy')">
                EASY (0-9) <span style="font-size:10px">初級</span>
            </button>
            <button class="btn btn-diff btn-normal" onclick="game.start('normal')">
                NORMAL (0-19) <span style="font-size:10px">中級</span>
            </button>
            <button class="btn btn-diff btn-hard" onclick="game.start('hard')">
                HARD (0-30) <span style="font-size:10px">上級</span>
            </button>
        </div>
    </div>

    <div id="gameover-screen" class="hidden">
        <canvas id="mascot-canvas-over" width="100" height="100"></canvas>
        <h1 id="result-title">MISSION OVER</h1>
        <p id="result-final">0</p>
        <div id="rank-list-container"></div>
        <button class="btn" onclick="location.reload()">Return to Menu</button>
    </div>
</div>

<script>
const OPS = {
    add: { label: '+', op: '+' }, sub: { label: '-', op: '-' },
    mul: { label: '×', op: '*' }, div: { label: '÷', op: '/' }
};

const MISSIONS = [
    { id: 'odd', label: 'ODD NUMS', sub: '奇数をロックせよ (1,3,5...)', color: '#FF0055' },
    { id: 'even', label: 'EVEN NUMS', sub: '偶数をロックせよ (2,4,6...)', color: '#00CCFF' },
    { id: 'asc', label: 'ASCEND', sub: '小さい順にロックせよ (1→2→3)', color: '#00FF00' },
    { id: 'desc', label: 'DESCEND', sub: '大きい順にロックせよ (9→8→7)', color: '#FFCC00' }
];

const RANKS = [
    { min: 30000, nameEn: "WHITE SHRIMP",   nameJa: "シロエビ" },
    { min: 20000, nameEn: "ISE LOBSTER",    nameJa: "伊勢海老" },
    { min: 10000, nameEn: "WILD PRAWN",     nameJa: "クルマエビ(天然)" },
    { min: 6000,  nameEn: "BOTAN SHRIMP",   nameJa: "ボタンエビ" },
    { min: 3000,  nameEn: "SWEET SHRIMP",   nameJa: "アマエビ" },
    { min: 1000,  nameEn: "BLACK TIGER",    nameJa: "ブラックタイガー" },
    { min: 0,     nameEn: "SAKURA SHRIMP",  nameJa: "サクラエビ" }
];

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.commCanvas = document.getElementById('comm-canvas');
        this.commCtx = this.commCanvas.getContext('2d');
        this.commState = 'normal';

        setTimeout(() => this.resize(), 100);
        window.addEventListener('resize', () => this.resize());
        this.state = 'menu';
        this.score = 0; this.maxTime = 60; this.timeLeft = this.maxTime;
        
        this.entities = []; 
        this.selectedEntities = [];
        this.lasers = [];
        this.effects = [];
        
        this.mission = null;
        this.combo = 0;
        this.lastSelectedVal = -1;
        this.bgScroll = 0;
        this.scanAngle = 0;
        this.maxNum = 30;

        this.drawStaticMascot('mascot-canvas-menu', 'normal');
        this.drawStaticMascot('mascot-canvas-over', 'panic');
        this.updateCommander('normal');

        // タップ操作に変更
        this.canvas.addEventListener('pointerdown', (e) => this.handleClick(e));
        
        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);
    }

    resize() {
        const dpr = window.devicePixelRatio || 1;
        this.width = window.innerWidth; this.height = window.innerHeight;
        this.canvas.width = this.width * dpr; this.canvas.height = this.height * dpr;
        this.canvas.style.width = this.width + 'px'; this.canvas.style.height = this.height + 'px';
        this.ctx.scale(dpr, dpr);
        const topSpace = 180; const bottomSpace = 180; 
        this.centerY = topSpace + (this.height - topSpace - bottomSpace) / 2;
        this.centerX = this.width / 2;
        const maxRadius = Math.min(this.width, (this.height - topSpace - bottomSpace)) / 2;
        this.radarRadius = Math.max(0, maxRadius - 10);
        if (this.state === 'playing' && this.entities.length === 0) { this.replenishEntities(15); }
    }

    start(mode) {
        if (mode === 'easy') { this.maxNum = 9; }
        else if (mode === 'normal') { this.maxNum = 19; }
        else { this.maxNum = 30; }

        this.resize(); this.state = 'playing'; this.score = 0; this.timeLeft = this.maxTime;
        this.selectedEntities = []; this.entities = []; this.lasers = []; this.effects = [];
        this.combo = 0;
        
        this.updateCommander('normal');
        this.replenishEntities(15);
        this.setNextMission();
        this.updateUI();
        document.getElementById('menu-screen').classList.add('hidden');
        document.getElementById('gameover-screen').classList.add('hidden');
    }

    setNextMission() {
        // 20%でボス（計算）、それ以外は反射神経
        if (this.score > 500 && Math.random() < 0.2) {
            this.setBossMission();
            return;
        }

        let next;
        do { next = MISSIONS[Math.floor(Math.random() * MISSIONS.length)]; } 
        while (this.mission && this.mission.id === next.id);
        
        this.mission = next;
        this.lastSelectedVal = -1;
        this.updateMissionUI();
    }

    setBossMission() {
        const targets = [
            { val: 6, op: 'mul', label: 'TARGET: 6', sub: '掛け算で作れ (例: 2×3)' },
            { val: 12, op: 'mul', label: 'TARGET: 12', sub: '掛け算で作れ (例: 3×4)' },
            { val: 10, op: 'add', label: 'TARGET: 10', sub: '足し算で作れ (例: 5+5)' }
        ];
        const t = targets[Math.floor(Math.random()*targets.length)];
        this.mission = { id: 'calc', label: t.label, sub: t.sub, targetVal: t.val, targetOp: t.op, color: '#FFFFFF' };
        this.lastSelectedVal = -1;
        this.updateMissionUI();
        this.updateCommander('panic');
        this.ensureBossSolvable();
    }

    updateMissionUI() {
        const title = document.getElementById('mission-display');
        const guide = document.getElementById('guide-msg');
        
        title.innerText = this.mission.label;
        title.style.color = this.mission.color;
        
        title.classList.remove('pulse-text');
        void title.offsetWidth;
        title.classList.add('pulse-text');

        guide.innerHTML = `MISSION<span class="sub">${this.mission.sub}</span>`;
    }

    replenishEntities(count) {
        if(count <= 0) return;
        const area = this.width * this.height;
        for (let i = 0; i < count; i++) { this.spawnEntity(); }
    }

    spawnEntity() {
        const baseR = Math.min(this.width, this.height) / 16; 
        const r = Math.max(16, Math.min(24, baseR)); 
        let x, y, safe = false, attempts = 0;
        
        while (!safe && attempts < 50) {
            attempts++;
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.sqrt(Math.random()) * (this.radarRadius - r - 5);
            x = this.centerX + Math.cos(angle) * dist;
            y = this.centerY + Math.sin(angle) * dist;
            safe = true;
            for (let ent of this.entities) {
                if (Math.hypot(ent.x - x, ent.y - y) < r * 2.1) { safe = false; break; } 
            }
        }
        if (!safe) return; 

        // ボス戦中のみ演算子を混ぜる
        let type = 'num';
        let val = Math.floor(Math.random() * (this.maxNum + 1));
        if (this.mission && this.mission.id === 'calc' && Math.random() < 0.4) {
            type = 'op';
            val = ['add','mul'][Math.floor(Math.random()*2)];
        }

        this.entities.push({ 
            type: type, val: val, x: x, y: y, r: r, selected: false, scale: 0,
            vx: (Math.random()-0.5)*0.5, vy: (Math.random()-0.5)*0.5
        });
    }

    ensureBossSolvable() {
        const t = this.mission.targetVal;
        const op = this.mission.targetOp === 'mul' ? 'mul' : 'add';
        // 簡易解を追加
        this.entities.push({ type:'num', val:1, x:this.centerX, y:this.centerY, r:20, selected:false, scale:1, vx:0, vy:0 });
        this.entities.push({ type:'op', val:op, x:this.centerX+40, y:this.centerY, r:20, selected:false, scale:1, vx:0, vy:0 });
        this.entities.push({ type:'num', val:t, x:this.centerX-40, y:this.centerY, r:20, selected:false, scale:1, vx:0, vy:0 });
    }

    // ★タップ操作（ロックオン）
    handleClick(e) {
        if (this.state !== 'playing') return;
        const rect = this.canvas.getBoundingClientRect();
        const x = e.clientX - rect.left;
        const y = e.clientY - rect.top;
        
        for (let ent of this.entities) {
            const dist = Math.hypot(ent.x - x, ent.y - y);
            if (dist < ent.r + 15) {
                ent.selected = !ent.selected; // トグル
                if (ent.selected) {
                    ent.scale = 1.3;
                    ent.selectTime = Date.now(); // 昇順降順用
                }
                this.updateFireBtn();
                return;
            }
        }
    }

    updateFireBtn() {
        const btn = document.getElementById('fire-btn');
        const selected = this.entities.filter(e => e.selected);
        if (selected.length > 0) {
            btn.classList.add('ready');
            // 数式バー更新
            let txt = "";
            if (this.mission.id === 'asc' || this.mission.id === 'desc' || this.mission.id === 'calc') {
                selected.sort((a,b) => a.selectTime - b.selectTime);
            }
            selected.forEach(e => {
                txt += (e.type==='op' ? OPS[e.val].label : e.val) + " ";
            });
            document.getElementById('formula-bar').innerText = txt;
        } else {
            btn.classList.remove('ready');
            document.getElementById('formula-bar').innerText = "";
        }
    }

    // ★発射（ハイマットフルバースト）
    fire() {
        const selected = this.entities.filter(e => e.selected);
        if (selected.length === 0) return;

        // 昇順・降順・計算は選択順にソート
        if (['asc', 'desc', 'calc'].includes(this.mission.id)) {
            selected.sort((a,b) => a.selectTime - b.selectTime);
        }

        let success = false;
        let bonus = 0;

        if (this.mission.id === 'calc') {
            // 計算モード
            if (selected.length >= 3) {
                let exp = "";
                let hasOp = false;
                selected.forEach(e => {
                    let v = e.val;
                    if (e.type === 'op') {
                        v = OPS[e.val].op;
                        if (e.val === this.mission.targetOp) hasOp = true;
                    }
                    exp += v;
                });
                try {
                    const res = new Function('return ' + exp)();
                    if (res === this.mission.targetVal && hasOp) {
                        success = true;
                        bonus = 5000;
                    }
                } catch(e){}
            }
        } else {
            // 反射神経モード
            let allOK = true;
            let lastV = -1;
            selected.forEach((e, i) => {
                if (e.type !== 'num') { allOK = false; return; }
                const v = e.val;
                if (this.mission.id === 'odd' && v % 2 === 0) allOK = false;
                if (this.mission.id === 'even' && v % 2 !== 0) allOK = false;
                if (this.mission.id === 'asc') {
                    if (i > 0 && v <= lastV) allOK = false;
                    lastV = v;
                }
                if (this.mission.id === 'desc') {
                    if (i > 0 && v >= lastV) allOK = false;
                    lastV = v;
                }
            });
            if (allOK && selected.length > 0) {
                success = true;
                bonus = selected.length * 100 * (1 + selected.length * 0.1);
            }
        }

        if (success) {
            // 成功演出
            selected.forEach(e => {
                this.lasers.push({ tx: e.x, ty: e.y, color: this.mission.color, life: 1.0 });
                this.createExplosion(e.x, e.y, this.mission.color);
            });
            // 消去
            this.entities = this.entities.filter(e => !e.selected);
            this.score += Math.floor(bonus);
            this.addEffect({text: `BURST! +${Math.floor(bonus)}`, color: this.mission.color, size: 40});
            this.updateCommander('happy');
            
            // 次へ
            if (this.mission.id === 'calc') {
                this.setNextMission();
                setTimeout(() => this.updateCommander('normal'), 1000);
            } else {
                this.combo++;
                if (this.combo >= 3) { this.combo = 0; this.setNextMission(); }
            }
            this.replenishEntities(15 - this.entities.length);

        } else {
            // 失敗
            this.entities.forEach(e => e.selected = false);
            this.addEffect({text: "MISS...", color: "#888", size: 30});
            this.timeLeft -= 3;
            this.updateCommander('panic');
        }

        this.updateFireBtn();
        this.updateUI();
    }

    autoLock() {
        if (this.state !== 'playing') return;
        const targets = [];
        this.entities.forEach(e => {
            let match = false;
            if (this.mission.id === 'odd') match = (e.type === 'num' && e.val % 2 !== 0);
            else if (this.mission.id === 'even') match = (e.type === 'num' && e.val % 2 === 0);
            else if (this.mission.id === 'calc') match = true; // 計算時は全消し
            else match = (e.type === 'num'); // 昇順降順はとりあえず数字
            if (match) targets.push(e);
        });

        if (targets.length > 0) {
            targets.forEach(e => {
                this.lasers.push({ tx: e.x, ty: e.y, color: '#FF00FF', life: 1.0 });
                this.createExplosion(e.x, e.y, '#FF00FF');
            });
            this.entities = this.entities.filter(e => !targets.includes(e));
            this.score += targets.length * 200;
            this.addEffect({text: "MAP WPN!!", color: "#FF00FF", size: 50});
            this.updateCommander('happy');
            this.replenishEntities(15);
        }
    }

    createExplosion(x, y, color) {
        for(let i=0; i<8; i++) {
            this.effects.push({
                type: 'particle', x, y, color, life: 1.0,
                vx: (Math.random()-0.5)*10, vy: (Math.random()-0.5)*10
            });
        }
    }

    manualShuffle() {
        if (this.state !== 'playing') return;
        this.entities = [];
        this.replenishEntities(15);
        this.addEffect({text: "RESHUFFLE!", color: "#FFA500", size: 24});
    }

    updateUI() {
        document.getElementById('score-display').innerText = `SCORE: ${this.score}`;
        document.getElementById('timer-display').innerText = `TIME: ${Math.floor(this.timeLeft)}`;
        const pct = Math.max(0, (this.timeLeft / this.maxTime) * 100);
        const bar = document.getElementById('time-bar');
        bar.style.width = `${pct}%`;
        bar.style.backgroundColor = pct < 20 ? '#FF4136' : '#0074D9';
    }

    update(dt) {
        this.scanAngle += dt * 1.5; 
        this.bgScroll += dt * 20; 
        this.entities.forEach(ent => {
            ent.x += ent.vx; ent.y += ent.vy;
            if (ent.x < ent.r || ent.x > this.width - ent.r) ent.vx *= -1;
            if (ent.y < 180 || ent.y > this.height - 180) ent.vy *= -1;
            if (ent.scale < 1) ent.scale += dt * 5;
            if (ent.scale > 1) ent.scale = 1;
        });
        
        if (this.state === 'playing') {
            this.timeLeft -= dt; this.updateUI();
            if (this.timeLeft <= 0) this.gameOver();
        }

        // Effects
        for (let i = this.effects.length - 1; i >= 0; i--) {
            let eff = this.effects[i];
            if (eff.type === 'particle') {
                eff.x += eff.vx; eff.y += eff.vy; eff.life -= 0.05;
            } else {
                eff.y -= 0.5; eff.life -= 0.02; // Text
            }
            if (eff.life <= 0) this.effects.splice(i, 1);
        }

        // Lasers
        for (let i = this.lasers.length - 1; i >= 0; i--) {
            this.lasers[i].life -= 0.1;
            if (this.lasers[i].life <= 0) this.lasers.splice(i, 1);
        }
    }
    
    gameOver() {
        this.state = 'gameover';
        document.getElementById('gameover-screen').classList.remove('hidden');
        document.getElementById('result-final').innerText = this.score;
        const container = document.getElementById('rank-list-container');
        container.innerHTML = ''; 
        let playerRankFound = false;
        RANKS.forEach(rank => {
            const div = document.createElement('div');
            div.className = 'rank-item';
            let isMyRank = false;
            if (!playerRankFound && this.score >= rank.min) {
                isMyRank = true; playerRankFound = true; div.classList.add('active');
            }
            div.innerHTML = `
                <div class="rank-name-col">
                    <span class="rank-name-en">${rank.nameEn}</span>
                    <span class="rank-name-ja">${rank.nameJa}</span>
                </div>
                <div class="rank-score">${rank.min}</div>
                <div class="rank-arrow">${isMyRank ? '◀ YOU' : ''}</div>
            `;
            container.appendChild(div);
        });
        this.drawStaticMascot('mascot-canvas-over', 'panic');
    }

    addEffect(eff) {
        if (eff.x === undefined) eff.x = this.centerX;
        if (eff.y === undefined) eff.y = this.centerY;
        eff.life = 1.0;
        this.effects.push(eff);
    }

    draw() {
        this.ctx.fillStyle = '#050510'; this.ctx.fillRect(0, 0, this.width, this.height);
        this.drawSciFiRadarBackground(this.ctx, this.centerX, this.centerY, this.radarRadius);

        // Lasers
        this.ctx.globalCompositeOperation = 'lighter';
        this.lasers.forEach(l => {
            this.ctx.strokeStyle = l.color;
            this.ctx.lineWidth = 15 * l.life;
            this.ctx.lineCap = 'round';
            this.ctx.beginPath();
            this.ctx.moveTo(this.width/2, this.height);
            this.ctx.lineTo(l.tx, l.ty);
            this.ctx.stroke();
            this.ctx.lineWidth = 4 * l.life;
            this.ctx.strokeStyle = '#fff';
            this.ctx.stroke();
        });
        this.ctx.globalCompositeOperation = 'source-over';

        // Bubbles
        this.entities.forEach(ent => {
            const size = ent.r * ent.scale;
            this.ctx.fillStyle = ent.type === 'op' ? '#FF4136' : (ent.selected ? '#FFDC00' : '#0074D9');
            
            this.ctx.beginPath(); this.ctx.arc(ent.x, ent.y, size, 0, Math.PI*2); this.ctx.fill();
            this.ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
            this.ctx.beginPath(); this.ctx.ellipse(ent.x - size * 0.3, ent.y - size * 0.3, size * 0.2, size * 0.1, Math.PI / 4, 0, Math.PI * 2); this.ctx.fill();

            if (ent.selected) {
                this.drawLockSight(ent.x, ent.y, size + 8, this.mission.color);
            }
            this.ctx.fillStyle = '#000'; this.ctx.textAlign = 'center'; this.ctx.textBaseline = 'middle';
            this.ctx.font = size > 20 ? 'bold 22px Arial' : 'bold 16px Arial';
            let label = ent.type === 'num' ? ent.val : OPS[ent.val].label;
            this.ctx.fillText(label, ent.x, ent.y);
        });

        // Effects
        this.effects.forEach(eff => {
            if (eff.type === 'particle') {
                this.ctx.globalAlpha = eff.life;
                this.ctx.fillStyle = eff.color;
                this.ctx.beginPath(); this.ctx.arc(eff.x, eff.y, 4, 0, Math.PI*2); this.ctx.fill();
            } else {
                this.ctx.globalAlpha = eff.life;
                this.ctx.fillStyle = eff.color; 
                this.ctx.font = `bold ${eff.size || 20}px Arial`;
                this.ctx.textAlign = 'center'; this.ctx.fillText(eff.text, eff.x, eff.y);
            }
            this.ctx.globalAlpha = 1.0;
        });
    }
    
    // UI Drawing Helpers
    drawStaticMascot(canvasId, mood) {
        const c = document.getElementById(canvasId);
        if(!c) return;
        const cx = c.getContext('2d');
        cx.clearRect(0,0,100,100);
        this.drawEbiGratinFace(cx, 50, 50, 40, mood);
    }

    updateCommander(mood) {
        this.commState = mood;
        this.commCtx.clearRect(0,0,70,70);
        this.drawEbiGratinFace(this.commCtx, 35, 35, 25, mood);
    }

    drawEbiGratinFace(ctx, x, y, size, mood) {
        ctx.fillStyle = mood==='panic'?'#A0A0FF':(mood==='happy'?'#FF4136':'#FFDB58');
        ctx.beginPath(); ctx.arc(x, y, size, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = '#8B4513';
        ctx.beginPath(); ctx.ellipse(x - size*0.4, y - size*0.5, size*0.2, size*0.1, 0, 0, Math.PI*2); ctx.fill();
        ctx.beginPath(); ctx.ellipse(x + size*0.3, y - size*0.4, size*0.25, size*0.15, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#000'; ctx.beginPath();
        if (mood === 'happy') {
            ctx.arc(x - size*0.3, y, size*0.15, Math.PI, 0); ctx.stroke(); ctx.beginPath();
            ctx.arc(x + size*0.3, y, size*0.15, Math.PI, 0); ctx.stroke();
        } else {
            ctx.arc(x - size*0.3, y + size*0.1, size*0.1, 0, Math.PI * 2);
            ctx.arc(x + size*0.3, y + size*0.1, size*0.1, 0, Math.PI * 2); ctx.fill();
        }
        ctx.beginPath(); ctx.lineWidth = 2;
        if (mood === 'panic') {
            ctx.moveTo(x-size*0.2, y+size*0.3); ctx.lineTo(x+size*0.2, y+size*0.3); ctx.stroke();
        } else {
            ctx.arc(x, y + size*0.1, size*0.3, 0.2*Math.PI, 0.8*Math.PI); ctx.stroke();
        }
    }

    drawLockSight(x, y, r, color) {
        this.ctx.strokeStyle = color; this.ctx.lineWidth = 3; 
        this.ctx.shadowBlur = 10; this.ctx.shadowColor = color;
        this.ctx.beginPath(); this.ctx.arc(x, y, r, 0, Math.PI*2); this.ctx.stroke();
        
        // Rotating Part
        this.ctx.save(); this.ctx.translate(x, y);
        this.ctx.rotate(Date.now() / 150);
        this.ctx.beginPath(); this.ctx.arc(0, 0, r * 0.8, 0, Math.PI*1.5); this.ctx.stroke();
        this.ctx.restore();
        this.ctx.shadowBlur = 0;
    }

    drawSciFiRadarBackground(ctx, x, y, r) {
        const baseColor = this.mission ? this.mission.color : '#00FFFF';
        // (省略: Shrimp Editionと同じ描画ロジック)
        ctx.save(); ctx.translate(x, y);
        ctx.strokeStyle = 'rgba(0,255,255,0.1)'; ctx.lineWidth = 1;
        const gridSize = 40; const offset = this.bgScroll % gridSize;
        for(let i = -r; i < r; i+=gridSize) {
            ctx.beginPath(); ctx.moveTo(i - offset, -r); ctx.lineTo(i - offset, r); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(-r, i + offset); ctx.lineTo(r, i + offset); ctx.stroke();
        }
        ctx.restore();
        ctx.save(); ctx.translate(x, y); ctx.rotate(this.scanAngle);
        const grad = ctx.createLinearGradient(0, 0, r, 0);
        grad.addColorStop(0, "rgba(0,255,255,0)"); grad.addColorStop(1, "rgba(0,255,255,0.1)");
        ctx.fillStyle = grad; ctx.beginPath(); ctx.moveTo(0, 0); ctx.arc(0, 0, r, -0.3, 0.3); ctx.fill(); 
        ctx.restore();
    }
}

window.onload = () => { window.game = new Game(); };
</script>
</body>
</html>
