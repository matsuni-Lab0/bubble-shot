<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bubble Shot: Light-Weight - Undefined Blue</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #111; color: white; font-family: sans-serif; touch-action: none; user-select: none; }
        #game-container { position: relative; width: 100vw; height: 100dvh; background-color: #050510; }
        canvas { display: block; width: 100%; height: 100%; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        #top-area { height: 200px; display: flex; flex-direction: column; align-items: center; background: linear-gradient(to bottom, rgba(0,0,0,0.9), rgba(0,0,0,0)); padding-top: 10px; }
        #mission-timer-wrapper { width: 150px; height: 4px; background: #222; margin-top: 5px; border-radius: 2px; overflow: hidden; }
        #mission-timer-bar { width: 100%; height: 100%; background: #FF4136; }
        #mission-display { font-size: 42px; font-weight: 900; color: #FFDC00; margin: 0; text-shadow: 0 0 20px #FFDC00; }
        #sync-gauge-container { width: 220px; height: 8px; background: #222; border-radius: 4px; border: 1px solid #444; margin-top: 15px; }
        #sync-gauge { width: 0%; height: 100%; background: cyan; }
        #bottom-area { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; }
        #fire-btn { width: 160px; height: 60px; background: rgba(255, 65, 54, 0.2); border: 2px solid #555; color: #555; font-size: 24px; font-weight: 900; display: flex; justify-content: center; align-items: center; pointer-events: auto; }
        #fire-btn.ready { background: rgba(255, 65, 54, 0.8); border: none; color: white; box-shadow: 0 0 30px #FF4136; }
        .hidden { display: none !important; }
        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; pointer-events: auto; }
    </style>
</head>
<body>

<div id="game-container">
    <canvas id="gameCanvas"></canvas>
    <div id="ui-layer">
        <div id="top-area">
            <div id="mission-label" style="font-size:10px; color:cyan;">MISSION WINDOW</div>
            <div id="mission-timer-wrapper"><div id="mission-timer-bar"></div></div>
            <div id="mission-display">READY</div>
            <div id="sync-gauge-container"><div id="sync-gauge"></div></div>
        </div>
        <div id="bottom-area"><div id="fire-btn" onclick="game.fire()">SHOT</div></div>
    </div>
    <div id="menu-screen" class="overlay">
        <h1>BUBBLE SHOT</h1>
        <button style="padding:15px 50px; border:2px solid #FFDC00; background:none; color:#FFDC00;" onclick="game.start()">ENGAGE</button>
    </div>
</div>

<script>
const MISSIONS = [{id:'odd',t:'ODD',c:v=>v%2!==0},{id:'even',t:'EVEN',c:v=>v%2===0}];

class Game {
    constructor() {
        this.canvas = document.getElementById('gameCanvas');
        this.ctx = this.canvas.getContext('2d');
        this.entities = []; this.effects = []; this.lasers = [];
        this.score = 0; this.syncRatio = 0; this.missionTimeLeft = 10;
        this.state = 'menu'; this.lastTime = 0; this.burstWave = 0;
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.canvas.addEventListener('pointerdown', (e) => this.handleClick(e));
        requestAnimationFrame((t) => this.loop(t));
    }

    resize() {
        const dpr = window.devicePixelRatio || 1;
        this.width = window.innerWidth; this.height = window.innerHeight;
        this.canvas.width = this.width * dpr; this.canvas.height = this.height * dpr;
        this.ctx.scale(dpr, dpr);
        this.centerX = this.width / 2; this.centerY = 200 + (this.height - 350) / 2;
        this.radarRadius = Math.min(this.width, this.height - 350) / 2 - 10;
    }

    start() {
        this.state = 'playing'; this.score = 0; this.entities = [];
        this.nextMission(); this.replenish();
        document.getElementById('menu-screen').classList.add('hidden');
    }

    nextMission() {
        this.currentMission = MISSIONS[Math.floor(Math.random() * MISSIONS.length)];
        this.missionTimeLeft = 10;
        document.getElementById('mission-display').innerText = this.currentMission.t;
        this.entities.forEach(e => e.locked = false);
        this.updateFireButton();
    }

    replenish() {
        while (this.entities.length < 20) {
            const r = 22;
            const angle = Math.random() * Math.PI * 2;
            const dist = Math.sqrt(Math.random()) * (this.radarRadius - r - 5);
            const x = this.centerX + Math.cos(angle) * dist;
            const y = this.centerY + Math.sin(angle) * dist;
            this.entities.push({ x, y, r, val: Math.floor(Math.random() * 50), scale: 0, locked: false });
        }
    }

    handleClick(e) {
        if(this.state !== 'playing') return;
        const rect = this.canvas.getBoundingClientRect();
        const tx = e.clientX - rect.left; const ty = e.clientY - rect.top;
        for(let ent of this.entities) {
            if(Math.hypot(ent.x - tx, ent.y - ty) < ent.r + 15) {
                ent.locked = !ent.locked; this.updateFireButton(); return;
            }
        }
    }

    updateFireButton() {
        const btn = document.getElementById('fire-btn');
        if(this.entities.some(e => e.locked)) btn.classList.add('ready'); else btn.classList.remove('ready');
    }

    fire() {
        const locked = this.entities.filter(e => e.locked);
        if(!locked.length) return;
        this.score += Math.floor(this.missionTimeLeft * 100);
        locked.forEach(ent => {
            const isHit = this.currentMission.c(ent.val);
            this.lasers.push({ x1: this.width/2, y1: this.height, x2: ent.x, y2: ent.y, life: 0.2, color: isHit ? '#00FFFF' : '#FF4136' });
            if(isHit) { this.score += 200; this.syncRatio = Math.min(100, this.syncRatio + 5); }
            else { this.syncRatio = Math.max(0, this.syncRatio - 10); }
        });
        this.entities = this.entities.filter(e => !e.locked);
        this.replenish(); this.updateFireButton();
        if(this.syncRatio >= 100) this.fullBurst();
        setTimeout(() => this.nextMission(), 200);
    }

    fullBurst() {
        this.state = 'burst';
        this.burstWave = 0;
        this.syncRatio = 0;
        // 演出用フラッシュ
        this.effects.push({ type: 'flash', life: 0.5 });
    }

    loop(t) {
        const dt = (t - this.lastTime) / 1000; this.lastTime = t;
        if(this.state === 'playing') {
            this.missionTimeLeft -= dt;
            if(this.missionTimeLeft <= 0) this.nextMission();
            document.getElementById('sync-gauge').style.width = this.syncRatio + '%';
            document.getElementById('mission-timer-bar').style.width = (this.missionTimeLeft/10)*100 + '%';
        }
        if(this.state === 'burst') {
            this.burstWave += dt * 1500;
            if(this.burstWave > this.width * 1.5) {
                this.state = 'playing'; this.entities = []; this.replenish(); this.nextMission();
            }
        }
        this.draw();
        requestAnimationFrame((t) => this.loop(t));
    }

    draw() {
        const ctx = this.ctx;
        ctx.fillStyle = '#050510'; ctx.fillRect(0, 0, this.width, this.height);
        
        // レーダー枠
        ctx.strokeStyle = '#00FFFF'; ctx.lineWidth = 4;
        ctx.beginPath(); ctx.arc(this.centerX, this.centerY, this.radarRadius, 0, Math.PI*2); ctx.stroke();

        // レーザー描画 (短寿命で負荷減)
        this.lasers = this.lasers.filter(l => {
            ctx.strokeStyle = l.color; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.moveTo(l.x1, l.y1); ctx.lineTo(l.x2, l.y2); ctx.stroke();
            l.life -= 0.02; return l.life > 0;
        });

        // フルバーストウェーブ
        if(this.state === 'burst') {
            ctx.strokeStyle = 'magenta'; ctx.lineWidth = 10;
            ctx.beginPath(); ctx.arc(this.width/2, this.height, this.burstWave, 0, Math.PI*2); ctx.stroke();
            this.entities.forEach(e => {
                if(Math.hypot(e.x - this.width/2, e.y - this.height) < this.burstWave) e.scale = 0;
            });
        }

        // エンティティ
        this.entities.forEach(ent => {
            if(ent.scale < 1) ent.scale += 0.1;
            ctx.strokeStyle = ent.locked ? '#FF00FF' : '#00FFFF';
            ctx.beginPath(); ctx.arc(ent.x, ent.y, ent.r * ent.scale, 0, Math.PI*2); ctx.stroke();
            ctx.fillStyle = 'white'; ctx.textAlign = 'center'; ctx.fillText(ent.val, ent.x, ent.y + 5);
        });

        // フラッシュエフェクト
        this.effects = this.effects.filter(f => {
            if(f.type === 'flash') { ctx.fillStyle = `rgba(255,255,255,${f.life})`; ctx.fillRect(0,0,this.width,this.height); }
            f.life -= 0.05; return f.life > 0;
        });
    }
}
window.game = new Game();
</script>
</body>
</html>
